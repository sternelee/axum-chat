{% macro message(variant, text) %}
<div class="chat {% if variant == 'human' %}chat-end{% else %}chat-start{% endif %}">
  <div class="chat-image avatar">
    <div class="w-10 rounded-full">
      {% if variant == 'human' %}
      <img alt="User Avatar" src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
      {% else %}
      <div class="bg-neutral text-neutral-content grid place-content-center w-full h-full rounded-full">AI</div>
      {% endif %}
    </div>
  </div>
  <div class="chat-header">
    {% if variant == 'human' %}
    You
    {% else %}
    Assistant
    {% endif %}
    <time class="text-xs opacity-50">12:45</time>
  </div>
  <div class="chat-bubble prose max-w-none">
    {% if variant == "ai-sse" %}
    <div id="message-container">
      <div id="thinking-placeholder"></div>
      <div id="reasoning-placeholder"></div>
      <div class="prose max-w-none">
        <span class="loading loading-dots loading-md"></span>
      </div>
    </div>
    <script>
      (function () {
        const eventSource = new EventSource('/chat/{{ chat_id }}/generate');
        const messageContainer = document.getElementById('message-container');
        let hasContent = false;

        // Store event source globally for cancellation
        window.currentEventSource = eventSource;

        // Cancel request on page refresh/close
        window.addEventListener('beforeunload', function() {
          if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
            eventSource.close();
          }
        });

        // Disable input and change send button to cancel during AI response
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendButtonIcon = sendButton?.querySelector('svg');
        const voiceButton = document.getElementById('voice-btn');
        const fileUploadLabel = document.querySelector('label[for="file-upload"]');

        // Store original send button content
        const originalButtonHTML = sendButton?.innerHTML;

        console.log('Send button found:', sendButton ? 'YES' : 'NO');

        // Change to cancel button
        if (sendButton) {
          sendButton.type = 'button';
          sendButton.classList.remove('btn-primary');
          sendButton.classList.add('btn-error');
          sendButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          `;
          sendButton.title = 'Cancel';

          // Add cancel handler
          sendButton.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            eventSource.close();
            // Append cancellation message instead of replacing content
            if (hasContent) {
              messageContainer.innerHTML += '<div class="mt-2 text-warning italic">Request cancelled by user</div>';
            } else {
              messageContainer.innerHTML = '<span class="text-warning">Request cancelled by user</span>';
            }
            restoreButton();
          };
        }

        if (messageInput) messageInput.disabled = true;
        if (voiceButton) voiceButton.disabled = true;
        if (fileUploadLabel) fileUploadLabel.style.pointerEvents = 'none';

        function restoreButton() {
          if (sendButton && originalButtonHTML) {
            sendButton.type = 'submit';
            sendButton.classList.remove('btn-error');
            sendButton.classList.add('btn-primary');
            sendButton.innerHTML = originalButtonHTML;
            sendButton.title = 'Send';
            sendButton.onclick = null;
          }
          if (messageInput) messageInput.disabled = false;
          if (voiceButton) voiceButton.disabled = false;
          if (fileUploadLabel) fileUploadLabel.style.pointerEvents = 'auto';
          window.currentEventSource = null;
        }

        eventSource.onmessage = function (event) {
          if (event.data) {
            hasContent = true;

            try {
              // Parse event data to check if it's a special update
              const data = JSON.parse(event.data);

              if (data.type === 'thinking_update') {
                // Update thinking section
                const thinkingContainer = document.getElementById('thinking-container');
                if (thinkingContainer) {
                  // Replace existing thinking container
                  thinkingContainer.outerHTML = data.html;
                } else {
                  // Insert thinking before the prose content
                  const prose = messageContainer.querySelector('.prose');
                  if (prose) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    prose.parentNode.insertBefore(tempDiv.firstChild, prose);
                  }
                }
              } else if (data.type === 'reasoning_update') {
                // Update reasoning section
                const reasoningContainer = document.getElementById('reasoning-container');
                if (reasoningContainer) {
                  // Replace existing reasoning container
                  reasoningContainer.outerHTML = data.html;
                } else {
                  // Insert reasoning after thinking but before prose
                  const prose = messageContainer.querySelector('.prose');
                  const thinkingContainer = document.getElementById('thinking-container');
                  if (prose) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    if (thinkingContainer && thinkingContainer.nextElementSibling === prose) {
                      prose.parentNode.insertBefore(tempDiv.firstChild, prose);
                    } else {
                      prose.parentNode.insertBefore(tempDiv.firstChild, prose);
                    }
                  }
                }
              } else {
                // Regular content update
                messageContainer.innerHTML = event.data;
              }
            } catch (e) {
              // Not JSON, treat as regular HTML
              messageContainer.innerHTML = event.data;
            }

            // Auto-scroll during streaming
            const container = document.getElementById('chat-messages');
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          }
        };

        eventSource.addEventListener('close', function (event) {
          eventSource.close();
          restoreButton();
        });

        eventSource.onerror = function (event) {
          console.error('SSE error:', event);
          if (!hasContent) {
            messageContainer.innerHTML = '<span class="text-error">Error loading response</span>';
          }
          eventSource.close();
          restoreButton();
        };
      })();
    </script>
    {% else %}
    {{text | safe}}
    {% endif %}
  </div>
  <div class="chat-footer opacity-50">
    Delivered
  </div>
</div>
{% endmacro input %}
