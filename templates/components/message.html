{% macro message(variant, text) %}
<div class="chat {% if variant == 'human' %}chat-end{% else %}chat-start{% endif %}">
  <div class="chat-image avatar">
    <div class="w-10 rounded-full">
      {% if variant == 'human' %}
      <img alt="User Avatar" src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
      {% else %}
      <div class="bg-neutral text-neutral-content grid place-content-center w-full h-full rounded-full">AI</div>
      {% endif %}
    </div>
  </div>
  <div class="chat-header">
    {% if variant == 'human' %}
    You
    {% else %}
    Assistant
    {% endif %}
    <time class="text-xs opacity-50">12:45</time>
  </div>
  <div class="chat-bubble prose max-w-none">
    {% if variant == "ai-sse" %}
    <div id="message-container">
      <span class="loading loading-dots loading-md"></span>
    </div>
    <script>
      (function () {
        const eventSource = new EventSource('/chat/{{ chat_id }}/generate');
        const messageContainer = document.getElementById('message-container');
        let hasContent = false;
        
        // Disable input during AI response
        const messageInput = document.getElementById('message-input');
        const sendButton = document.querySelector('#chat-form button[type="submit"]');
        const voiceButton = document.getElementById('voice-btn');
        const fileUploadLabel = document.querySelector('label[for="file-upload"]');
        
        if (messageInput) messageInput.disabled = true;
        if (sendButton) sendButton.disabled = true;
        if (voiceButton) voiceButton.disabled = true;
        if (fileUploadLabel) fileUploadLabel.style.pointerEvents = 'none';

        function enableInput() {
          if (messageInput) messageInput.disabled = false;
          if (sendButton) sendButton.disabled = false;
          if (voiceButton) voiceButton.disabled = false;
          if (fileUploadLabel) fileUploadLabel.style.pointerEvents = 'auto';
        }

        eventSource.onmessage = function (event) {
          if (event.data) {
            hasContent = true;
            messageContainer.innerHTML = event.data;
            // Auto-scroll during streaming
            const container = document.getElementById('chat-messages');
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          }
        };

        eventSource.addEventListener('close', function (event) {
          eventSource.close();
          enableInput();
        });

        eventSource.onerror = function (event) {
          console.error('SSE error:', event);
          if (!hasContent) {
            messageContainer.innerHTML = '<span class="text-error">Error loading response</span>';
          }
          eventSource.close();
          enableInput();
        };
      })();
    </script>
    {% else %}
    {{text | safe}}
    {% endif %}
  </div>
  <div class="chat-footer opacity-50">
    Delivered
  </div>
</div>
{% endmacro input %}