{% import "components/message.html" as macros %}
{% import "components/provider-picker.html" as provider_macros %}
{% import "components/agent-provider-picker.html" as agent_provider_macros %}

<div class="drawer lg:drawer-open h-full">
    <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col bg-base-100 relative h-full overflow-hidden">
        <!-- Page content here -->

        <!-- Mobile toggle -->
        <div class="lg:hidden p-2 border-b border-base-200 flex items-center gap-2 sticky top-0 bg-base-100 z-10">
            <label for="my-drawer-2" class="btn btn-ghost btn-sm drawer-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="inline-block w-5 h-5 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </label>
            <span class="font-semibold">Chat History</span>
        </div>

        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 pb-32 min-h-0 scroll-smooth">
            {% if chat_id is undefined %}
            <!-- Show agent/provider selector for new chat -->
            {% if agents or providers %}
            <div class="max-w-4xl mx-auto">
                {{ agent_provider_macros::agent_provider_picker(agents=agents, providers=providers, selected_agent=selected_agent, selected_provider=selected_provider) }}
            </div>
            {% endif %}
            {% elif selected_agent %}
            <div class="flex justify-center gap-2 mb-4 sticky top-0 z-10">
                <div class="badge badge-primary badge-lg">{{ selected_agent.icon }} {{ selected_agent.name }}</div>
                <div class="badge badge-outline badge-lg">{{ selected_agent.provider.name }} - {{ selected_agent.model_name }}</div>
                {% if selected_agent.stream %}
                <div class="badge badge-success badge-sm">Streaming</div>
                {% endif %}
                {% if selected_agent.tool %}
                <div class="badge badge-warning badge-sm">Tools</div>
                {% endif %}
            </div>
            {% elif selected_provider %}
            <div class="flex justify-center gap-2 mb-4 sticky top-0 z-10">
                <div class="badge badge-primary badge-lg">{{ selected_provider.name }}</div>
                <div class="badge badge-outline badge-lg">{{ selected_provider.provider_type | title }}</div>
            </div>
            {% endif %}


            <div class="flex flex-col gap-4 max-w-4xl mx-auto">
                {% if chat_message_pairs %}
                {% for pair in chat_message_pairs %}

                {{ macros::message(variant="human", text=pair.human_message_html) }}

                {% if pair.pair.ai_message %}
                {{ macros::message(variant="ai", text=pair.ai_message_html) }}
                {% else %}
                {{ macros::message(variant="ai-sse", text="") }}
                {% endif %}

                {% endfor %}
                {% endif %}

                <div id="new-message"></div>
            </div>
        </div>
        <script>
            function scrollToBottom() {
                const container = document.getElementById('chat-messages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            // Scroll on load
            window.addEventListener('load', scrollToBottom);

            // Scroll after HTMX swap (new user message)
            document.body.addEventListener('htmx:afterSwap', function (evt) {
                if (evt.detail.target.id === 'new-message') {
                    scrollToBottom();
                }
            });
        </script>

        <div class="absolute bottom-0 left-0 right-0 bg-base-100/80 backdrop-blur-sm p-4 border-t border-base-200">
            <div class="max-w-4xl mx-auto">
                {% if chat_id is defined %}
                <form method="post" hx-post="/api/chat/{{ chat_id }}/message/add" hx-target="#new-message"
                    hx-swap="outerHTML">
                    <div class="join w-full shadow-lg">
                        <textarea name="message" class="textarea textarea-bordered join-item w-full resize-none"
                            placeholder="Type your message here..."></textarea>
                        <button type="submit" class="btn btn-primary join-item">Send</button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>

    </div>
    <div class="drawer-side z-20 border-r border-base-300">
        <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
        <div class="menu p-4 w-80 min-h-full bg-base-200 text-base-content flex flex-col">
            <!-- Sidebar content here -->
            <a href="/chat" class="btn btn-primary w-full mb-4 gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                New Chat
            </a>

            <div class="flex-grow overflow-y-auto">
                <ul class="menu w-full p-0">
                    {% if user_chats %}
                    {% for chat in user_chats %}
                    <li class="relative group">
                        <a href="/chat/{{ chat.id }}"
                            class="{% if chat_id and chat_id==chat.id %}active{% endif %} flex justify-between items-center pr-12">
                            <span class="truncate">{{ chat.name }}</span>
                        </a>
                        <button class="btn btn-ghost btn-xs absolute right-2 top-2 hidden group-hover:flex text-error"
                            hx-delete="/chat/{{ chat.id }}" hx-target="closest li" hx-swap="outerHTML">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                class="w-4 h-4">
                                <path fill-rule="evenodd"
                                    d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.49 1.478l-.56-.172a6.022 6.022 0 00-1.383-.248H2.37c-.36.058-.72.128-1.083.202a.75.75 0 01-.253-1.478 48.567 48.567 0 013.878-.512V4.479A2.25 2.25 0 017.125 2.25h9.75a2.25 2.25 0 012.125 2.228zM4.5 6.75v10.5a3 3 0 003 3h9a3 3 0 003-3V6.75a.75.75 0 00-.75-.75H5.25a.75.75 0 00-.75.75z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>

            <div class="divider"></div>
            <div class="text-center text-xs opacity-50">
                Built by <a href="https://www.bitswired.com" target="_blank" class="link link-hover">Bitswired</a> ðŸ’š
            </div>
        </div>
    </div>
</div>