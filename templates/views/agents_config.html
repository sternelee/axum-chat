<div class="container mx-auto p-4 max-w-7xl">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">AI Agents Configuration</h1>
    <p class="text-gray-600">Create and manage AI agents with different capabilities and personalities</p>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="stat bg-base-100 shadow-lg rounded-lg">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-8 h-8 stroke-current">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
      </div>
      <div class="stat-title">Total Agents</div>
      <div class="stat-value text-primary" id="totalAgents">0</div>
    </div>

    <div class="stat bg-base-100 shadow-lg rounded-lg">
      <div class="stat-figure text-success">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-8 h-8 stroke-current">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div class="stat-title">Active Agents</div>
      <div class="stat-value text-success" id="activeAgents">0</div>
    </div>

    <div class="stat bg-base-100 shadow-lg rounded-lg">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-8 h-8 stroke-current">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
      <div class="stat-title">Categories</div>
      <div class="stat-value text-info" id="totalCategories">0</div>
    </div>

    <div class="stat bg-base-100 shadow-lg rounded-lg">
      <div class="stat-figure text-warning">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-8 h-8 stroke-current">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
        </svg>
      </div>
      <div class="stat-title">Total Tools</div>
      <div class="stat-value text-warning" id="totalTools">0</div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" onclick="showCreateModal()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create Agent
          </button>
          <button class="btn btn-secondary" onclick="refreshAgents()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
          </button>
        </div>

        <div class="flex flex-wrap gap-2">
          <select class="select select-bordered select-sm" id="filterCategory" onchange="filterAgents()">
            <option value="">All Categories</option>
          </select>
          <select class="select select-bordered select-sm" id="filterProvider" onchange="filterAgents()">
            <option value="">All Providers</option>
          </select>
          <select class="select select-bordered select-sm" id="filterStatus" onchange="filterAgents()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Agents Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="agentsGrid">
    <!-- Agent cards will be dynamically populated here -->
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="hidden text-center py-12">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
    </svg>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No agents found</h3>
    <p class="text-gray-500 mb-4">Get started by creating your first AI agent.</p>
    <button class="btn btn-primary" onclick="showCreateModal()">Create Agent</button>
  </div>
</div>

<!-- Create/Edit Agent Modal -->
<div class="modal" id="agentModal">
  <div class="modal-box modal-wide">
    <h3 class="font-bold text-lg mb-4" id="modalTitle">Create New Agent</h3>

    <form id="agentForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Agent Name *</span>
          </label>
          <input type="text" id="agentName" class="input input-bordered w-full" required>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Icon (emoji)</span>
          </label>
          <input type="text" id="agentIcon" class="input input-bordered w-full" maxlength="2" placeholder="">
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Description</span>
        </label>
        <textarea id="agentDescription" class="textarea textarea-bordered w-full" rows="2" placeholder="Describe what this agent does..."></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Provider *</span>
          </label>
          <select id="agentProvider" class="select select-bordered w-full" required onchange="loadModels()">
            <option value="">Select Provider</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Model *</span>
          </label>
          <select id="agentModel" class="select select-bordered w-full" required>
            <option value="">Select Model</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Category</span>
          </label>
          <select id="agentCategory" class="select select-bordered w-full">
            <option value="assistant">Assistant</option>
            <option value="developer">Developer</option>
            <option value="creative">Creative</option>
            <option value="analyst">Analyst</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Status</span>
          </label>
          <select id="agentStatus" class="select select-bordered w-full">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">System Prompt</span>
        </label>
        <textarea id="agentSystemPrompt" class="textarea textarea-bordered w-full" rows="4" placeholder="You are a helpful AI assistant..."></textarea>
      </div>

      <div class="card bg-base-200">
        <div class="card-body">
          <h4 class="card-title text-base">Capabilities</h4>

          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentChat" class="checkbox checkbox-primary" checked>
                <span class="label-text">Chat</span>
              </label>
            </div>

            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentStream" class="checkbox checkbox-primary" checked>
                <span class="label-text">Streaming</span>
              </label>
            </div>

            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentImage" class="checkbox checkbox-primary">
                <span class="label-text">Vision</span>
              </label>
            </div>

            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentTools" class="checkbox checkbox-primary">
                <span class="label-text">Tools</span>
              </label>
            </div>

            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentFiles" class="checkbox checkbox-primary">
                <span class="label-text">File Upload</span>
              </label>
            </div>

            <div class="form-control">
              <label class="cursor-pointer label">
                <input type="checkbox" id="agentEmbed" class="checkbox checkbox-primary">
                <span class="label-text">Embedding</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="card bg-base-200">
        <div class="card-body">
          <h4 class="card-title text-base">Parameters</h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text">Temperature</span>
                <span class="label-text-alt" id="tempValue">0.7</span>
              </label>
              <input type="range" id="agentTemperature" class="range range-primary" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempValue').textContent = this.value">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Max Tokens</span>
              </label>
              <input type="number" id="agentMaxTokens" class="input input-bordered w-full" value="2048" min="1" max="8192">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Top P</span>
                <span class="label-text-alt" id="topPValue">1.0</span>
              </label>
              <input type="range" id="agentTopP" class="range range-primary" min="0" max="1" step="0.01" value="1.0" oninput="document.getElementById('topPValue').textContent = this.value">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Max Context</span>
              </label>
              <input type="number" id="agentMaxContext" class="input input-bordered w-full" value="4096" min="1" max="128000">
            </div>
          </div>
        </div>
      </div>

      <div class="form-control">
        <label class="cursor-pointer label">
          <input type="checkbox" id="agentPublic" class="checkbox checkbox-primary">
          <span class="label-text">Make this agent public (visible to all users)</span>
        </label>
      </div>
    </form>

    <div class="modal-action">
      <button class="btn btn-ghost" onclick="closeAgentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveAgent()">Save Agent</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeAgentModal()"></div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Delete Agent</h3>
    <p class="py-4">Are you sure you want to delete this agent? This action cannot be undone.</p>
    <div class="modal-action">
      <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-error" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
</div>

<script>
let agents = [];
let providers = [];
let currentEditingAgent = null;
let deleteAgentId = null;

// Load initial data
async function loadAgents() {
  try {
    const response = await fetch('/api/agents');
    const data = await response.json();
    agents = data.agents || [];
    renderAgents();
    updateStats();
    populateFilters();
  } catch (error) {
    console.error('Failed to load agents:', error);
    showToast('Failed to load agents', 'error');
  }
}

async function loadProviders() {
  try {
    const response = await fetch('/api/providers');
    providers = await response.json();

    const providerSelect = document.getElementById('agentProvider');
    const filterProvider = document.getElementById('filterProvider');

    providers.forEach(provider => {
      const option = new Option(provider.name, provider.id);
      providerSelect.add(option.cloneNode(true));

      if (provider.is_active) {
        filterProvider.add(option);
      }
    });
  } catch (error) {
    console.error('Failed to load providers:', error);
  }
}

async function loadModels() {
  const providerId = document.getElementById('agentProvider').value;
  const modelSelect = document.getElementById('agentModel');

  modelSelect.innerHTML = '<option value="">Select Model</option>';

  if (!providerId) return;

  // Find the provider to check if it has models_endpoint
  const provider = providers.find(p => p.id.toString() === providerId);

  if (!provider) {
    modelSelect.innerHTML = '<option value="">Provider not found</option>';
    return;
  }

  // Check if provider supports models_endpoint
  if (!provider.models_endpoint) {
    modelSelect.innerHTML = '<option value="">This provider does not support model discovery</option>';
    return;
  }

  // Show loading state
  modelSelect.innerHTML = '<option value="">Loading models...</option>';

  try {
    // Try public endpoint first, then fallback to authenticated endpoint
    const publicUrl = `/api/providers/${providerId}/models`;
    const privateUrl = `/api/providers/${providerId}/models`;

    console.log('=== FRONTEND MODEL FETCH DEBUG ===');
    console.log('Provider ID:', providerId);
    console.log('Provider Name:', provider.name);
    console.log('Models Endpoint:', provider.models_endpoint);
    console.log('Public URL:', publicUrl);
    console.log('Private URL:', privateUrl);
    console.log('==================================');

    let response;
    let usedUrl;

    try {
      console.log('Trying public endpoint first...');
      response = await fetch(publicUrl);
      usedUrl = publicUrl;
      console.log('Public endpoint response:', response.status);
    } catch (error) {
      console.log('Public endpoint failed, trying private endpoint...', error);
      response = await fetch(privateUrl);
      usedUrl = privateUrl;
      console.log('Private endpoint response:', response.status);
    }

    console.log('Final URL Used:', usedUrl);
    console.log('Response Status:', response.status);
    console.log('Response Headers:', [...response.headers.entries()]);

    if (!response.ok) {
      const errorText = await response.text();
      console.log('Error Response Body:', errorText);
      throw new Error(`HTTP ${response.status}: ${response.statusText} from ${usedUrl}`);
    }

    const models = await response.json();
    console.log('Models Response:', models);
    console.log('Models array length:', models.length);

    if (models.length === 0) {
      modelSelect.innerHTML = '<option value="">No models available for this provider</option>';
      return;
    }

    modelSelect.innerHTML = '<option value="">Select Model</option>';

    models.forEach(model => {
      // Create detailed option text with model information
      let displayText = model.display_name || model.name;
      let details = [];

      if (model.context_length) {
        details.push(`${model.context_length.toLocaleString()} tokens`);
      }

      if (model.pricing && model.pricing.input_price) {
        details.push(`$${model.pricing.input_price}/1K input`);
      }

      if (model.pricing && model.pricing.output_price) {
        details.push(`$${model.pricing.output_price}/1K output`);
      }

      if (model.support_streaming) {
        details.push('Streaming');
      }

      if (model.support_tools) {
        details.push('Tools');
      }

      if (model.support_images) {
        details.push('Vision');
      }

      const optionText = details.length > 0
        ? `${displayText} (${details.join(', ')})`
        : displayText;

      const option = new Option(optionText, model.name);

      // Add additional data as attributes for potential future use
      option.dataset.contextLength = model.context_length || '';
      option.dataset.supportsStreaming = model.support_streaming || false;
      option.dataset.supportsTools = model.support_tools || false;
      option.dataset.supportsImages = model.support_images || false;

      modelSelect.add(option);
    });

  } catch (error) {
    console.error('Failed to load models:', error);
    modelSelect.innerHTML = '<option value="">Failed to load models. Please try again.</option>';
    showToast('Failed to load models: ' + error.message, 'error');
  }
}

function renderAgents() {
  const grid = document.getElementById('agentsGrid');
  const emptyState = document.getElementById('emptyState');

  if (agents.length === 0) {
    grid.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }

  grid.classList.remove('hidden');
  emptyState.classList.add('hidden');

  grid.innerHTML = agents.map(agent => createAgentCard(agent)).join('');
}

function createAgentCard(agent) {
  const capabilities = [];
  if (agent.chat) capabilities.push('<span class="badge badge-outline badge-sm">Chat</span>');
  if (agent.stream) capabilities.push('<span class="badge badge-outline badge-sm">Streaming</span>');
  if (agent.image) capabilities.push('<span class="badge badge-outline badge-sm">Vision</span>');
  if (agent.tool) capabilities.push('<span class="badge badge-outline badge-sm">Tools</span>');
  if (agent.file) capabilities.push('<span class="badge badge-outline badge-sm">Files</span>');
  if (agent.embed) capabilities.push('<span class="badge badge-outline badge-sm">Embedding</span>');

  const statusBadge = agent.is_active
    ? '<div class="badge badge-success">Active</div>'
    : '<div class="badge badge-error">Inactive</div>';

  const publicBadge = agent.public
    ? '<span class="badge badge-info ml-2">Public</span>'
    : '';

  return `
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
      <div class="card-body">
        <div class="flex justify-between items-start mb-2">
          <div class="flex items-center">
            <span class="text-3xl mr-3">${agent.icon || ''}</span>
            <div>
              <h2 class="card-title text-lg">${agent.name}</h2>
              ${publicBadge}
            </div>
          </div>
          ${statusBadge}
        </div>

        <p class="text-gray-600 mb-3 line-clamp-2">${agent.description || 'No description available'}</p>

        <div class="text-sm space-y-1 mb-3">
          <div class="flex justify-between">
            <span><strong>Model:</strong></span>
            <span class="badge badge-ghost badge-sm">${agent.model_name}</span>
          </div>
          <div class="flex justify-between">
            <span><strong>Provider:</strong></span>
            <span class="badge badge-ghost badge-sm">${agent.provider.name}</span>
          </div>
          <div class="flex justify-between">
            <span><strong>Category:</strong></span>
            <span class="badge badge-ghost badge-sm">${agent.category}</span>
          </div>
        </div>

        <div class="flex flex-wrap gap-1 mb-4">
          ${capabilities.join('')}
        </div>

        <div class="text-xs text-gray-500 mb-4">
          <div>Temperature: ${agent.temperature}</div>
          <div>Max Tokens: ${agent.max_tokens}</div>
        </div>

        <div class="card-actions justify-end">
          <button onclick="editAgent(${agent.id})" class="btn btn-sm btn-outline">Edit</button>
          <button onclick="viewAgentDetails(${agent.id})" class="btn btn-sm btn-outline">Details</button>
          <button onclick="deleteAgent(${agent.id})" class="btn btn-sm btn-error btn-outline">Delete</button>
        </div>
      </div>
    </div>
  `;
}

function updateStats() {
  const totalAgents = agents.length;
  const activeAgents = agents.filter(a => a.is_active).length;
  const categories = new Set(agents.map(a => a.category)).size;
  const totalTools = agents.reduce((sum, a) => sum + (a.tools || []).length, 0);

  document.getElementById('totalAgents').textContent = totalAgents;
  document.getElementById('activeAgents').textContent = activeAgents;
  document.getElementById('totalCategories').textContent = categories;
  document.getElementById('totalTools').textContent = totalTools;
}

function populateFilters() {
  const categorySelect = document.getElementById('filterCategory');
  const categories = [...new Set(agents.map(a => a.category))];

  categories.forEach(category => {
    const option = new Option(category, category);
    categorySelect.add(option);
  });
}

function filterAgents() {
  const category = document.getElementById('filterCategory').value;
  const provider = document.getElementById('filterProvider').value;
  const status = document.getElementById('filterStatus').value;

  let filtered = agents;

  if (category) {
    filtered = filtered.filter(a => a.category === category);
  }

  if (provider) {
    filtered = filtered.filter(a => a.provider.id.toString() === provider);
  }

  if (status) {
    const isActive = status === 'active';
    filtered = filtered.filter(a => a.is_active === isActive);
  }

  // Render filtered results
  const grid = document.getElementById('agentsGrid');
  const emptyState = document.getElementById('emptyState');

  if (filtered.length === 0) {
    grid.classList.add('hidden');
    emptyState.classList.remove('hidden');
    emptyState.querySelector('h3').textContent = 'No agents match the filters';
  } else {
    grid.classList.remove('hidden');
    emptyState.classList.add('hidden');
    grid.innerHTML = filtered.map(agent => createAgentCard(agent)).join('');
  }
}

function showCreateModal() {
  currentEditingAgent = null;
  document.getElementById('modalTitle').textContent = 'Create New Agent';
  document.getElementById('agentForm').reset();
  document.getElementById('tempValue').textContent = '0.7';
  document.getElementById('topPValue').textContent = '1.0';
  document.getElementById('agentModal').classList.add('modal-open');
}

function editAgent(id) {
  const agent = agents.find(a => a.id === id);
  if (!agent) return;

  currentEditingAgent = agent;
  document.getElementById('modalTitle').textContent = 'Edit Agent';

  // Populate form
  document.getElementById('agentName').value = agent.name;
  document.getElementById('agentIcon').value = agent.icon || '';
  document.getElementById('agentDescription').value = agent.description || '';
  document.getElementById('agentProvider').value = agent.provider.id;
  document.getElementById('agentCategory').value = agent.category;
  document.getElementById('agentStatus').value = agent.is_active.toString();
  document.getElementById('agentSystemPrompt').value = agent.system_prompt || '';

  // Capabilities
  document.getElementById('agentChat').checked = agent.chat;
  document.getElementById('agentStream').checked = agent.stream;
  document.getElementById('agentImage').checked = agent.image;
  document.getElementById('agentTools').checked = agent.tool;
  document.getElementById('agentFiles').checked = agent.file;
  document.getElementById('agentEmbed').checked = agent.embed;

  // Parameters
  document.getElementById('agentTemperature').value = agent.temperature;
  document.getElementById('tempValue').textContent = agent.temperature;
  document.getElementById('agentMaxTokens').value = agent.max_tokens;
  document.getElementById('agentTopP').value = agent.top_p;
  document.getElementById('topPValue').textContent = agent.top_p;
  document.getElementById('agentMaxContext').value = agent.max_context;

  document.getElementById('agentPublic').checked = agent.public;

  // Load models for this provider
  loadModels().then(() => {
    document.getElementById('agentModel').value = agent.model_name;
  });

  document.getElementById('agentModal').classList.add('modal-open');
}

async function saveAgent() {
  const formData = {
    name: document.getElementById('agentName').value,
    icon: document.getElementById('agentIcon').value || '',
    description: document.getElementById('agentDescription').value,
    provider_id: parseInt(document.getElementById('agentProvider').value),
    model_name: document.getElementById('agentModel').value,
    category: document.getElementById('agentCategory').value,
    system_prompt: document.getElementById('agentSystemPrompt').value,
    chat: document.getElementById('agentChat').checked,
    stream: document.getElementById('agentStream').checked,
    image: document.getElementById('agentImage').checked,
    tool: document.getElementById('agentTools').checked,
    file: document.getElementById('agentFiles').checked,
    embed: document.getElementById('agentEmbed').checked,
    temperature: parseFloat(document.getElementById('agentTemperature').value),
    max_tokens: parseInt(document.getElementById('agentMaxTokens').value),
    top_p: parseFloat(document.getElementById('agentTopP').value),
    max_context: parseInt(document.getElementById('agentMaxContext').value),
    public: document.getElementById('agentPublic').checked,
    is_active: document.getElementById('agentStatus').value === 'true'
  };

  try {
    const url = currentEditingAgent ? `/api/agents/${currentEditingAgent.id}` : '/api/agents';
    const method = currentEditingAgent ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });

    if (response.ok) {
      showToast(`Agent ${currentEditingAgent ? 'updated' : 'created'} successfully`, 'success');
      closeAgentModal();
      loadAgents();
    } else {
      throw new Error('Failed to save agent');
    }
  } catch (error) {
    console.error('Error saving agent:', error);
    showToast('Failed to save agent: ' + error.message, 'error');
  }
}

function deleteAgent(id) {
  deleteAgentId = id;
  document.getElementById('deleteModal').classList.add('modal-open');
}

async function confirmDelete() {
  if (!deleteAgentId) return;

  try {
    const response = await fetch(`/api/agents/${deleteAgentId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      showToast('Agent deleted successfully', 'success');
      closeDeleteModal();
      loadAgents();
    } else {
      throw new Error('Failed to delete agent');
    }
  } catch (error) {
    console.error('Error deleting agent:', error);
    showToast('Failed to delete agent: ' + error.message, 'error');
  }
}

function viewAgentDetails(id) {
  const agent = agents.find(a => a.id === id);
  if (!agent) return;

  // Create a simple details modal
  const detailsHtml = `
    <div class="space-y-4">
      <div>
        <h4 class="font-bold text-lg flex items-center">
          <span class="text-2xl mr-2">${agent.icon || ''}</span>
          ${agent.name}
        </h4>
        <p class="text-gray-600">${agent.description || 'No description'}</p>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <span class="font-semibold">Provider:</span> ${agent.provider.name}
        </div>
        <div>
          <span class="font-semibold">Model:</span> ${agent.model_name}
        </div>
        <div>
          <span class="font-semibold">Category:</span> ${agent.category}
        </div>
        <div>
          <span class="font-semibold">Status:</span> ${agent.is_active ? 'Active' : 'Inactive'}
        </div>
      </div>

      <div>
        <span class="font-semibold">System Prompt:</span>
        <p class="mt-1 p-2 bg-gray-100 rounded text-sm">${agent.system_prompt || 'None'}</p>
      </div>

      <div>
        <span class="font-semibold">Parameters:</span>
        <div class="mt-1 text-sm">
          Temperature: ${agent.temperature}, Max Tokens: ${agent.max_tokens}, Top P: ${agent.top_p}
        </div>
      </div>
    </div>
  `;

  // Show in a temporary modal
  const modal = document.createElement('div');
  modal.className = 'modal modal-open';
  modal.innerHTML = `
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Agent Details</h3>
      ${detailsHtml}
      <div class="modal-action">
        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
      </div>
    </div>
    <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
  `;
  document.body.appendChild(modal);
}

function closeAgentModal() {
  document.getElementById('agentModal').classList.remove('modal-open');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('modal-open');
  deleteAgentId = null;
}

function refreshAgents() {
  loadAgents();
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-top toast-end`;
  toast.innerHTML = `
    <div class="alert alert-${type}">
      <span>${message}</span>
    </div>
  `;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadAgents();
  loadProviders();
});
</script>

<style>
.modal-wide {
  max-width: 900px;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>