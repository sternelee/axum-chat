{% import "components/message.html" as macros %}
{% import "components/provider-picker.html" as provider_macros %}
{% import "components/agent-provider-picker.html" as agent_provider_macros %}

<div class="drawer lg:drawer-open h-full">
    <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col bg-base-100 relative h-full overflow-hidden">
        <!-- Page content here -->

        <!-- Mobile toggle -->
        <div class="lg:hidden p-2 border-b border-base-200 flex items-center gap-2 sticky top-0 bg-base-100 z-10">
            <label for="my-drawer-2" class="btn btn-ghost btn-sm drawer-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="inline-block w-5 h-5 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </label>
            <span class="font-semibold">Chat History</span>
        </div>

        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 pb-32 min-h-0 scroll-smooth">
            {% if chat_id is undefined %}
            <!-- Show agent/provider selector for new chat -->
            {% if agents or providers %}
            <div class="max-w-4xl mx-auto">
                {{ agent_provider_macros::agent_provider_picker(agents=agents, providers=providers, selected_agent=selected_agent, selected_provider=selected_provider) }}
            </div>
            {% endif %}
            {% elif selected_agent %}
            <div class="flex justify-center gap-2 mb-4 sticky top-0 z-10">
                <div class="badge badge-primary badge-lg">{{ selected_agent.icon }} {{ selected_agent.name }}</div>
                <div class="badge badge-outline badge-lg">{{ selected_agent.provider.name }} - {{ selected_agent.model_name }}</div>
                {% if selected_agent.stream %}
                <div class="badge badge-success badge-sm">Streaming</div>
                {% endif %}
                {% if selected_agent.tool %}
                <div class="badge badge-warning badge-sm">Tools</div>
                {% endif %}
            </div>
            {% elif selected_provider %}
            <div class="flex justify-center gap-2 mb-4 sticky top-0 z-10">
                <div class="badge badge-primary badge-lg">{{ selected_provider.name }}</div>
                <div class="badge badge-outline badge-lg">{{ selected_provider.provider_type | title }}</div>
            </div>
            {% endif %}


            <div class="flex flex-col gap-4 max-w-4xl mx-auto">
                {% if chat_message_pairs %}
                {% for pair in chat_message_pairs %}

                {{ macros::message(variant="human", text=pair.human_message_html) }}

                {% if pair.pair.ai_message %}
                {{ macros::message(variant="ai", text=pair.ai_message_html) }}
                {% else %}
                {{ macros::message(variant="ai-sse", text="") }}
                {% endif %}

                {% endfor %}
                {% endif %}

                <div id="new-message"></div>
            </div>
        </div>
        <script>
            function scrollToBottom() {
                const container = document.getElementById('chat-messages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            // Scroll on load
            window.addEventListener('load', scrollToBottom);

            // Scroll after HTMX swap (new user message)
            document.body.addEventListener('htmx:afterSwap', function (evt) {
                if (evt.detail.target.id === 'new-message') {
                    scrollToBottom();
                }
            });
        </script>

        <div class="absolute bottom-0 left-0 right-0 bg-base-100/80 backdrop-blur-sm p-4 border-t border-base-200">
            <div class="max-w-4xl mx-auto">
                {% if chat_id is defined %}
                <form x-data="{ 
                        message: '', 
                        files: [],
                        supportsImages: {% if (selected_agent and selected_agent.image) or (selected_provider and selected_provider.support_images) %}true{% else %}false{% endif %},
                        supportsFiles: {% if selected_agent and selected_agent.file %}true{% else %}false{% endif %},
                        addFiles(e) {
                            const newFiles = Array.from(e.target.files);
                            this.files = [...this.files, ...newFiles];
                            e.target.value = '';
                        },
                        removeFile(index) {
                            this.files.splice(index, 1);
                        }
                      }"
                      @htmx:after-request.camel="if($event.detail.successful) { message = ''; files = []; $nextTick(() => { $refs.input.focus(); $refs.input.style.height = 'auto'; }); }"
                      method="post" 
                      hx-post="/api/chat/{{ chat_id }}/message/add" 
                      hx-target="#new-message"
                      hx-swap="outerHTML">
                    <div class="w-full shadow-lg bg-base-100 rounded-xl border border-base-300 focus-within:border-primary transition-colors">
                        <!-- File Preview -->
                        <div x-show="files.length > 0" class="p-3 flex gap-2 overflow-x-auto border-b border-base-200" style="display: none;">
                            <template x-for="(file, index) in files" :key="index">
                                <div class="badge badge-neutral gap-2 p-3 h-auto">
                                    <span x-text="file.name" class="text-xs truncate max-w-[150px]"></span>
                                    <button type="button" @click="removeFile(index)" class="btn btn-ghost btn-xs btn-circle text-error min-h-0 h-5 w-5">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3">
                                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div class="flex items-end p-2 gap-2">
                            <!-- Attachment Buttons -->
                            <div class="flex gap-1 pb-1.5 text-base-content/60">
                                <template x-if="supportsImages">
                                    <div class="tooltip" data-tip="Upload Image">
                                        <button type="button" class="btn btn-ghost btn-sm btn-circle" @click="$refs.imageInput.click()">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                <template x-if="supportsFiles">
                                    <div class="tooltip" data-tip="Upload File">
                                        <button type="button" class="btn btn-ghost btn-sm btn-circle" @click="$refs.fileInput.click()">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                
                                <input type="file" x-ref="imageInput" class="hidden" accept="image/*" multiple @change="addFiles($event)">
                                <input type="file" x-ref="fileInput" class="hidden" multiple @change="addFiles($event)">
                            </div>

                            <textarea x-ref="input"
                                      x-model="message" 
                                      name="message" 
                                      class="textarea textarea-ghost w-full resize-none overflow-hidden min-h-[2.5rem] max-h-[200px] focus:bg-transparent px-2 py-2 leading-normal"
                                      placeholder="Type your message here..."
                                      rows="1"
                                      @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); $el.form.requestSubmit(); }"
                                      @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                                      x-init="$el.focus(); $el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"></textarea>
                            
                            <button type="submit" class="btn btn-primary btn-sm mb-1" :disabled="!message.trim() && files.length === 0">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                    <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>

    </div>
    <div class="drawer-side z-20 border-r border-base-300">
        <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
        <div class="menu p-4 w-80 min-h-full bg-base-200 text-base-content flex flex-col">
            <!-- Sidebar content here -->
            <a href="/chat" class="btn btn-primary w-full mb-4 gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                New Chat
            </a>

            <div class="flex-grow overflow-y-auto">
                <ul class="menu w-full p-0">
                    {% if user_chats %}
                    {% for chat in user_chats %}
                    <li class="relative group">
                        <a href="/chat/{{ chat.id }}"
                            class="{% if chat_id and chat_id==chat.id %}active{% endif %} flex justify-between items-center pr-12">
                            <span class="truncate">{{ chat.name }}</span>
                        </a>
                        <button class="btn btn-ghost btn-xs absolute right-2 top-2 hidden group-hover:flex text-error"
                            hx-delete="/chat/{{ chat.id }}" hx-target="closest li" hx-swap="outerHTML">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                class="w-4 h-4">
                                <path fill-rule="evenodd"
                                    d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.49 1.478l-.56-.172a6.022 6.022 0 00-1.383-.248H2.37c-.36.058-.72.128-1.083.202a.75.75 0 01-.253-1.478 48.567 48.567 0 013.878-.512V4.479A2.25 2.25 0 017.125 2.25h9.75a2.25 2.25 0 012.125 2.228zM4.5 6.75v10.5a3 3 0 003 3h9a3 3 0 003-3V6.75a.75.75 0 00-.75-.75H5.25a.75.75 0 00-.75.75z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>

            <div class="divider"></div>
            <div class="text-center text-xs opacity-50">
                Built by <a href="https://www.bitswired.com" target="_blank" class="link link-hover">Bitswired</a> ðŸ’š
            </div>
        </div>
    </div>
</div>
