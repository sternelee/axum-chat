{% macro message(variant, text) %}
<div
  class="chat {% if variant == 'human' %}chat-end{% else %}chat-start{% endif %}"
>
  <div class="chat-image avatar">
    <div class="w-10 rounded-full">
      {% if variant == 'human' %}
      <img
        alt="User Avatar"
        src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg"
      />
      {% else %}
      <div
        class="bg-neutral text-neutral-content grid place-content-center w-full h-full rounded-full"
      >
        AI
      </div>
      {% endif %}
    </div>
  </div>
  <div class="chat-header">
    {% if variant == 'human' %} You {% else %} Assistant {% endif %}
    <time class="text-xs opacity-50">12:45</time>
  </div>
  <div class="chat-bubble prose max-w-none min-w-full">
    {% if variant == "ai-sse" %}
    <div id="message-container flex flex-col gap-1">
      <div
        id="thinking-container"
        class="collapse collapse-arrow bg-base-200 mb-4 hidden"
      >
        <input type="checkbox" id="thinking-collapse" class="hidden" />
        <div
          class="collapse-title text-sm font-medium flex items-center gap-2 cursor-pointer"
          onclick="document.getElementById('thinking-container').classList.toggle('collapse-open')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
            />
          </svg>
          Thinking Process
        </div>
        <div class="collapse-content">
          <div class="text-sm opacity-75 whitespace-pre-wrap"></div>
        </div>
      </div>

      <div
        id="reasoning-container"
        class="collapse collapse-arrow bg-base-200 mb-4 hidden"
      >
        <input type="checkbox" id="reasoning-collapse" class="hidden" />
        <div
          class="collapse-title text-sm font-medium flex items-center gap-2 cursor-pointer"
          onclick="document.getElementById('reasoning-container').classList.toggle('collapse-open')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          Reasoning
        </div>
        <div class="collapse-content">
          <div class="text-sm opacity-75 whitespace-pre-wrap"></div>
        </div>
      </div>

      <div class="prose max-w-none">
        <span class="loading loading-dots loading-md"></span>
      </div>
    </div>
    <script>
      (function () {
        const eventSource = new EventSource("/chat/{{ chat_id }}/generate");
        const messageContainer = document.getElementById("message-container");
        let hasContent = false;

        // Store event source globally for cancellation
        window.currentEventSource = eventSource;

        // Cancel request on page refresh/close
        window.addEventListener("beforeunload", function () {
          if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
            eventSource.close();
          }
        });

        // Disable input and change send button to cancel during AI response
        const messageInput = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const sendButtonIcon = sendButton?.querySelector("svg");
        const voiceButton = document.getElementById("voice-btn");
        const fileUploadLabel = document.querySelector(
          'label[for="file-upload"]',
        );

        // Store original send button content
        const originalButtonHTML = sendButton?.innerHTML;

        console.log("Send button found:", sendButton ? "YES" : "NO");

        // Change to cancel button
        if (sendButton) {
          sendButton.type = "button";
          sendButton.classList.remove("btn-primary");
          sendButton.classList.add("btn-error");
          sendButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          `;
          sendButton.title = "Cancel";

          // Add cancel handler
          sendButton.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            eventSource.close();
            // Append cancellation message instead of replacing content
            if (hasContent) {
              messageContainer.innerHTML +=
                '<div class="mt-2 text-warning italic">Request cancelled by user</div>';
            } else {
              messageContainer.innerHTML =
                '<span class="text-warning">Request cancelled by user</span>';
            }
            restoreButton();
          };
        }

        if (messageInput) messageInput.disabled = true;
        if (voiceButton) voiceButton.disabled = true;
        if (fileUploadLabel) fileUploadLabel.style.pointerEvents = "none";

        function restoreButton() {
          if (sendButton && originalButtonHTML) {
            sendButton.type = "submit";
            sendButton.classList.remove("btn-error");
            sendButton.classList.add("btn-primary");
            sendButton.innerHTML = originalButtonHTML;
            sendButton.title = "Send";
            sendButton.onclick = null;
          }
          if (messageInput) messageInput.disabled = false;
          if (voiceButton) voiceButton.disabled = false;
          if (fileUploadLabel) fileUploadLabel.style.pointerEvents = "auto";
          window.currentEventSource = null;
        }

        eventSource.onmessage = function (event) {
          if (event.data) {
            hasContent = true;

            // Debug log to see what we're receiving
            console.log("SSE event data:", event.data);

            // Check if this is a tool call confirmation (special case that still needs JSON parsing)
            if (event.data.trim().startsWith('{"type":"tool_call_confirmation"')) {
              try {
                const data = JSON.parse(event.data);
                // Handle tool call confirmation request
                const confirmation = data.content;
                const toolName = confirmation.tool_call.function.name;
                const toolArgs = JSON.parse(confirmation.tool_call.function.arguments);

                console.log("Received tool call confirmation:", confirmation);

                const confirmationHtml = `
                  <div class="alert alert-info mt-4" id="tool-confirmation-${confirmation.id}">
                    <div class="flex items-start gap-3">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <div class="flex-1">
                        <h3 class="font-bold">Tool Call Confirmation Required</h3>
                        <div class="text-sm mt-1">
                          <p><strong>Tool:</strong> ${toolName}</p>
                          <p><strong>Description:</strong> ${confirmation.description || 'No description available'}</p>
                          ${Object.keys(toolArgs).length > 0 ?
                            `<p><strong>Arguments:</strong></p>
                             <pre class="bg-base-200 p-2 rounded text-xs overflow-x-auto">${JSON.stringify(toolArgs, null, 2)}</pre>`
                            : ''
                          }
                        </div>
                        <div class="flex gap-2 mt-3">
                          <button
                            class="btn btn-success btn-sm"
                            hx-post="/chat/${confirmation.chat_id}/tool-confirm/${confirmation.id}"
                            hx-target="#tool-confirmation-${confirmation.id}"
                            hx-swap="outerHTML">
                            Approve
                          </button>
                          <button
                            class="btn btn-error btn-sm"
                            hx-post="/chat/${confirmation.chat_id}/tool-reject/${confirmation.id}"
                            hx-target="#tool-confirmation-${confirmation.id}"
                            hx-swap="outerHTML">
                            Reject
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                messageContainer.innerHTML += confirmationHtml;
              } catch (e) {
                // console.error("Failed to parse tool call confirmation:", e);
                messageContainer.innerHTML = event.data;
              }
            } else {
              // Regular HTML content - just replace the entire message container
              messageContainer.innerHTML = event.data;
            }

            // Auto-scroll during streaming
            const container = document.getElementById("chat-messages");
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          }
        };

        eventSource.addEventListener("close", function (event) {
          eventSource.close();
          restoreButton();
        });

        eventSource.onerror = function (event) {
          console.error("SSE error:", event);
          if (!hasContent) {
            messageContainer.innerHTML =
              '<span class="text-error">Error loading response</span>';
          }
          eventSource.close();
          restoreButton();
        };
      })();
    </script>
    {% else %} {{text | safe}} {% endif %}
  </div>
  <div class="chat-footer opacity-50">Delivered</div>
</div>
{% endmacro input %}
